# 基础架构

如下图所示，大体来说，MySQL 可以分为 Server 层和存储引擎层两部分。

![SQL执行顺序](https://tva1.sinaimg.cn/large/006y8mN6ly1g70hnbgdsij31400u0tpc.jpg)

Server 层包括连接器、查询缓存、分析器、优化器、执行器等，涵盖 MySQL 的大多数核心服务功能，以及所有的内置函数（如日期、时间、数学和加密函数等），所有跨存储引擎的功能都在这一层实现，比如存储过程、触发器、视图等。

而存储引擎层负责数据的存储和提取。其架构模式是插件式的，支持 InnoDB、MyISAM、Memory 等多个存储引擎。现在最常用的存储引擎是 InnoDB，它从 MySQL 5.5.5 版本开始成为了默认存储引擎。

# 查询语句是如何执行的？

首先客户端需要和Server层建立连接，网络连接建立后就从权限表中查询用户的权限。之后这个连接相关的权限判断，都依赖于此时查询到的用户权限。**也就是说，一旦建立连接后，即使修改了用户权限，也不会影响已经存在连接的权限，只有新的连接才会使用新的权限**

连接建立后，MySQL会先去“查询缓存”看看这条查询语句之前是否执行过，如果命中了查询缓存则立即返回结果。如果没命中，则继续执行后续步骤。查询缓存的实效非常频繁，只要对一个表做了任何更新，这个表上的所有查询缓存都会失效。对于更新比较频繁的表，查询缓存命中的概率会非常低。

如果没有命中查询缓存，就开始真正执行查询语句了。首先MySQL需要先用分析器做“词法分析”，识别出输入的查询语句的每个字符串分别代表什么。然后还要做“语法分析”，基于词法分析的结果，判断输入的SQL是否满足语法规则。

这时，MySQL已经知道你要做什么了。但是，MySQL还会智能的判断如何做效率更高。比如在一个表里有多个索引的时候，选择哪个索引效率更高；或者在一个语句有多表关联的时候，决定各个表的关联顺序。

最后就进入了执行器阶段，开始真正的执行你的SQL。执行之前，需要先判断你对这个表有没有查询的权限。如果有权限，才可以继续执行。然后执行器根据定义的存储引擎，调用对应的接口，打开表，获取对应的字段。

# 更新语句是如何执行的

更新语句与查询语句类似，上图中的每个步骤都要执行。与查询流程不同的是，更新语句还涉及两个重要的日志模块：redo log（重做日志）和binlog（归档日志）。



# 日志系统





























